% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/create_citsa.R
\name{create_citsa}
\alias{create_citsa}
\title{Estimate intervention effects using Controlled Interrupted Time-Series
Analysis (CITSA) with treatment and control groups}
\usage{
create_citsa(
  data,
  metrics = NULL,
  control,
  before_start = NULL,
  before_end = NULL,
  after_start = NULL,
  after_end = NULL,
  ac_lags_max = 7,
  return = "table"
)
}
\arguments{
\item{data}{Person Query as a data frame including date column named
\code{MetricDate}. This function assumes the date format is \verb{\%Y-\%m-\%d} as is
standard in a Viva Insights query output.}

\item{metrics}{A character vector containing the variable names to perform
the controlled interrupted time series analysis for.}

\item{control}{String specifying the name of a binary column that
identifies the control group. This column should contain logical values
(TRUE/FALSE) or 0/1, where TRUE (or 1) indicates control group membership
and FALSE (or 0) indicates treatment group membership. For example, if you
have a column "IsControl" where TRUE means control group, pass "IsControl"
as this parameter.}

\item{before_start}{String specifying the start date of the 'before'
time period in \verb{\%Y-\%m-\%d} format. The 'before' time period refers to the
period before the intervention occurs. If not provided, this defaults to
the earliest date in the dataset. Longer pre-intervention periods increase
statistical power and allow better assessment of parallel trends assumption.}

\item{before_end}{String specifying the end date of 'before' time
period in \verb{\%Y-\%m-\%d} format. This parameter is required and defines the
last date before the intervention. The intervention is assumed to occur
between \code{before_end} and \code{after_start}.}

\item{after_start}{String specifying the start date of the 'after'
time period in \verb{\%Y-\%m-\%d} format. If \code{NULL}, this will default to the value
of \code{before_end}, assuming immediate intervention effect. The 'after' time
period refers to the post-intervention period. Longer post-intervention
periods improve detection of sustained effects and trend changes.}

\item{after_end}{String specifying the end date of the 'after' time
period in \verb{\%Y-\%m-\%d} format. If not provided, defaults to the latest date
in the dataset.}

\item{ac_lags_max}{Numeric value specifying the maximum lag for the
Ljung-Box autocorrelation test. The test checks for autocorrelation in
model residuals up to this number of lags. Higher values test for
longer-term dependencies. Default is 7. Consider increasing for data with
strong seasonal patterns or long-memory processes.}

\item{return}{String specifying what output to return. Valid options:
\itemize{
\item \code{'table'} (default): Returns a data frame with estimated coefficients,
p-values, and diagnostic information for all metrics.
\item \code{'plot'}: Returns a list of plots showing observed data, fitted lines
for both groups, and intervention effects.
\item \code{'plot_combined'}: Returns plots with treatment and control groups
overlaid on the same panel for direct comparison.
\item \code{'plot_difference'}: Returns plots showing the difference between
treatment and control groups over time, highlighting the differential
intervention effect.
}}
}
\value{
When 'table' is passed to \code{return}, a data frame with the following columns:
\itemize{
\item \code{metric_name}: Name of the metric being analyzed.
\item \code{beta_2}: Immediate level change in treatment group (intervention effect at time 0).
\item \code{beta_3}: Slope change in treatment group (sustained trend change).
\item \code{beta_6}: Differential immediate effect (treatment vs control) - \strong{key for causal inference}.
\item \code{beta_7}: Differential slope change (treatment vs control) - \strong{key for causal inference}.
\item \code{beta_2_pvalue}: P-value for treatment group immediate effect.
\item \code{beta_3_pvalue}: P-value for treatment group slope change.
\item \code{beta_6_pvalue}: P-value for differential immediate effect - \strong{focus here for intervention impact}.
\item \code{beta_7_pvalue}: P-value for differential slope change - \strong{focus here for sustained impact}.
\item \code{AR_flag}: Logical flag indicating whether autocorrelation was detected and corrected.
\item \code{n_treatment}: Number of observations in treatment group.
\item \code{n_control}: Number of observations in control group.
\item \code{error_warning}: Error or warning message if applicable.
}

When 'plot', 'plot_combined', or 'plot_difference' is passed to \code{return},
returns a named list of ggplot objects, one for each metric.
}
\description{
\ifelse{html}{\href{https://lifecycle.r-lib.org/articles/stages.html#experimental}{\figure{lifecycle-experimental.svg}{options: alt='[Experimental]'}}}{\strong{[Experimental]}}

This function implements a controlled (comparative) interrupted time-series
analysis method as described in Linden (2015). Unlike single-group ITSA,
this approach uses a control group to account for secular trends and
external factors, providing stronger causal inference about intervention
effects.

The function estimates a segmented regression model with interaction terms
to compare changes in outcomes between treatment and control groups before
and after an intervention. This method is particularly valuable when you
want to distinguish intervention effects from general time trends affecting
both groups.

This function requires the installation of 'sandwich' and 'lmtest' packages
from CRAN to handle autocorrelation and heteroscedasticity in time-series data.
}
\details{
\subsection{Statistical Model}{

The function fits the following segmented regression model:

\deqn{Y_t = \beta_0 + \beta_1 T_t + \beta_2 X_t + \beta_3 X_t T_t + \beta_4 Z + 
      \beta_5 Z T_t + \beta_6 Z X_t + \beta_7 Z X_t T_t + \epsilon_t}

Where:
\itemize{
\item \eqn{Y_t}: Outcome metric at time t
\item \eqn{T_t}: Time variable (continuous, centered at intervention)
\item \eqn{X_t}: Intervention indicator (0 = pre-intervention, 1 = post-intervention)
\item \eqn{Z}: Group indicator (0 = treatment, 1 = control)
\item \eqn{\epsilon_t}: Error term
}
}

\subsection{Key Coefficients and Interpretation}{

\strong{Treatment Group Effects:}
\itemize{
\item \eqn{\beta_2}: Immediate level change in treatment group at intervention
\item \eqn{\beta_3}: Change in slope (trend) in treatment group after intervention
}

\strong{Control Group Effects:}
\itemize{
\item \eqn{\beta_2 + \beta_6}: Immediate level change in control group
\item \eqn{\beta_3 + \beta_7}: Change in slope in control group
}

\strong{Differential Effects (Treatment vs Control):}
\itemize{
\item \eqn{\beta_6}: Difference in immediate intervention effect between groups
\item \eqn{\beta_7}: Difference in slope change between groups
}

\strong{Critical for Causal Inference:}
Focus on \eqn{\beta_6} and \eqn{\beta_7} with their p-values. Significant values
indicate that the intervention had different effects on treatment vs control
groups, suggesting a true intervention effect beyond secular trends.
}

\subsection{Assumptions and Recommendations}{

This method assumes:
\enumerate{
\item \strong{Parallel Trends}: Treatment and control groups would have followed
similar trends in the absence of intervention. Verify this by examining
pre-intervention trends.
\item \strong{Group Comparability}: Treatment and control groups are similar in
baseline characteristics. If not comparable, consider:
\itemize{
\item Propensity score matching before analysis
\item Inverse probability weighting
\item Covariate adjustment in the model
\item Stratification by key characteristics
}
\item \strong{No Contamination}: Control group is not affected by the intervention
(no spillover effects).
\item \strong{Stable Composition}: Group membership doesn't change over time, or
changes are minimal and random.
}
}

\subsection{Autocorrelation Handling}{

The function automatically tests for autocorrelation using the Ljung-Box test
and applies Newey-West heteroscedasticity and autocorrelation consistent (HAC)
standard errors when needed. This ensures valid inference even with correlated
residuals common in time-series data.
}

\subsection{References}{

Linden, A. (2015). Conducting interrupted time-series analysis for single- and
multiple-group comparisons. The Stata Journal, 15(2), 480-500.
}
}
\examples{
\dontrun{
library(dplyr)

# Simulate a controlled experiment dataset
# Randomly assign 40\% of unique PersonIds to control group
set.seed(123)
unique_persons <- unique(pq_data$PersonId)
control_persons <- sample(unique_persons, size = floor(0.4 * length(unique_persons)))

# Create control group indicator and simulate an intervention effect
pq_data_citsa <- pq_data \%>\%
  mutate(
    IsControl = PersonId \%in\% control_persons,
    # Simulate intervention effect: treatment group gets 15\% boost in collaboration
    # after 2024-07-01, control group has only a 3\% trend increase
    Collaboration_hours_modified = case_when(
      MetricDate > as.Date("2024-07-01") & !IsControl ~ 
        Collaboration_hours * 1.15,
      MetricDate > as.Date("2024-07-01") & IsControl ~ 
        Collaboration_hours * 1.03,
      TRUE ~ Collaboration_hours
    )
  )

# Returns summary table with comparative effects
create_citsa(
  data = pq_data_citsa,
  metrics = c("Collaboration_hours_modified", "Meeting_hours"),
  control = "IsControl",
  before_end = "2024-07-01",
  after_start = "2024-07-01",
  ac_lags_max = 7,
  return = "table"
)

# Returns list of plots with separate panels
plot_list <-
  create_citsa(
    data = pq_data_citsa,
    metrics = c("Collaboration_hours_modified", "Meeting_hours"),
    control = "IsControl",
    before_end = "2024-07-01",
    after_start = "2024-07-01",
    return = "plot"
  )

# Extract and view a specific plot
plot_list$Collaboration_hours_modified

# Combined overlay plot for direct comparison
create_citsa(
  data = pq_data_citsa,
  metrics = "Collaboration_hours_modified",
  control = "IsControl",
  before_end = "2024-07-01",
  return = "plot_combined"
)

# Difference plot showing intervention effect
create_citsa(
  data = pq_data_citsa,
  metrics = "Collaboration_hours_modified",
  control = "IsControl",
  before_end = "2024-07-01",
  return = "plot_difference"
)
}

}
\seealso{
Other Flexible Input: 
\code{\link{create_itsa}()}

Other Interrupted Time-Series Analysis: 
\code{\link{create_itsa}()}
}
\author{
Martin Chan \href{mailto:martin.chan@microsoft.com}{martin.chan@microsoft.com}
}
\concept{Flexible Input}
\concept{Interrupted Time-Series Analysis}
